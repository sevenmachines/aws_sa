\FloatBarrier

\section{Solution analysis}

The current implementation cannot be accessed from external networks. The service consists of,

\items{
	\item Networking is a VPC with CIDR $10.0.0.0/16$ with 2 public subnets $10.0.0.0/24$ and  $10.0.1.0/24$ in eu-west-1b and eu-west-1b respectively, as well as 2 private subnets $10.0.2.0/24$, $10.0.3.0/24$ in eu-west-1b and eu-west-1b. 
	
	\item VPC has an internet gateway and a classic load balancer (ELB)
	 
	\item Routing is setup up to allow all traffic between subnets and out to external addresses.
	
	\item There are 2 security groups, one for the single EC2 application instance, and one for the ELB.
	 
	\item DNS is enabled and the instance has a pubic IP address
}

\imagefigsingle
{aws_sa_v0_simple}
{My explanation}

\FloatBarrier

\issue{ELB healthcheck on wrong instance port}
{Change ELB port for healthcheck from 443 to 80}
{
	Httpd starts on-instance on port 80. The ELB correctly forwards ports
	from from 80 to instance port 80.  However, the healthcheck looks to verify instance health on port 443 through a tcp connection. This change simply targets the healthcheck correctly at port 80 on the instance.
}
{
	\imagefigsinglebox
	{lb-healthcheck_443}
	{In the AWS console, navigate to Services  $\rightarrow$ EC2  $\rightarrow$ Load Balancers and select the 'Health check' tab.}
	\imagefigsinglebox
	{lb-healthcheck_80}
	{Change the port from $443$ to $80$. This will leave the load balancer checking the instance health by connecting through tcp on the servers default HTTP port.}
}

\FloatBarrier


\issue{Load balancer cannot route to subnet}
{Add PublicSubnetA to load balancer}
{
	The ELB can only route to instances in PublicSubnetB. This change
	allows it to route to PublicSubnetA also, where the current instance is located.
}
{
	\imagefigsinglebox
	{lb-missing_subnet}
	{In the Load Balancers configuration page, select the load balancer and then the 'Instances' tab. Note that only the eu-west-1b zone is available to the load balancer, which has no instances}
	
	\imagefigsinglebox
		{lb-subnet_added}
	{Add 'PublicSubnetA' to the load balancers available subnets. This means that the load balancer can now direct traffic to the instance in eu-west-1a}
}

\FloatBarrier

\issue{The site cannot be accessed from external addresses}
{Add everywhere access to load balancer ingress}
{
Allow all addresses to access the load balancer on port 80
}
{
	\imagefigsinglebox
	{sg-elb_no_rules_full}
 	{ Navigate to Services  $\rightarrow$ EC2  $\rightarrow$ Security Groups. Select the ELBSecurityGroup group and the 'Inbound' tab. By default, no inbound rules are set.}
	\imagefigsinglebox
	{sg-elb_external_access}
	{Edit the group and add an inbound rule to allow http access from everywhere, $0.0.0.0/0$. Users will now be able to reach the load balancer from the internet and other external networks.}
}


\FloatBarrier


\issue{Instances cannot be accessed from the load balancer}
{Allow access to the instance from the ELB only}
{This change allows traffic from the ELB to the instances. This is set to all TCP traffic to port 80 to allow the ELBs TCP-based healthcheck to pass}
{
{
	\imagefigsinglebox
	{sg-app_no_rules_full}
	{Still in the 'Security Groups' section, select the 'AppServerSecurityGroup' group and the 'Inbound' tab. As we can see, there are no rules set.}
	\imagefigsinglebox
	{sg-allow_instance_access_from_elb}
	{Edit the group and add an inbound rule to allow http access from the ELBSecurityGroup. The security group Id needed for the 'Source' value can be found by typing 'sg' then choosing from one of the values in the popup menu.}
}
}

\FloatBarrier

\subsection{Success!}

You should see the site on your loadbalancers domain name \texttt{http://<load-balancer-dns-name>/demo.html}. The right DNS name can be found on the 'Description' tab of the 'Load balancers' configuration page when your load balancer is selected.

\imagefigsinglebox{lb-dns_name}{The DNS name of the load balancer can be found in the load balancers description tab}


\imagefigsinglebox{site-success}{The instances are now reachable through the load-balancer to customers on the internet}

\FloatBarrier